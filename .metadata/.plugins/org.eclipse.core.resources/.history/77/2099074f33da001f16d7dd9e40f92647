import javax.swing.*;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.Socket;
import java.util.List;

public class BileraV extends JFrame {
    private JTable table;
    private JTextArea txtDetalles;
    private DefaultTableModel model;

    public BileraV() {
        setTitle("Vista de Bilerak");
        setSize(800, 500);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        setLayout(new BorderLayout());

        // Configuración de la tabla
        String[] columnNames = {"Fecha", "Hora", "Estado", "Acción"};
        model = new DefaultTableModel(null, columnNames) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false; // Deshabilitar edición de celdas
            }
        };

        table = new JTable(model);
        table.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        table.setBackground(Color.DARK_GRAY);
        table.setForeground(Color.WHITE);
        table.setFont(new Font("Tahoma", Font.PLAIN, 14));
        table.setRowHeight(25);

        // Aplica el renderer de colores según el estado
        table.setDefaultRenderer(Object.class, new EstadoRenderer());

        JScrollPane scrollPane = new JScrollPane(table);
        add(scrollPane, BorderLayout.CENTER);

        // Panel de detalles
        JPanel panelDetalles = new JPanel();
        panelDetalles.setLayout(new BorderLayout());
        panelDetalles.setBackground(Color.GRAY);

        txtDetalles = new JTextArea();
        txtDetalles.setEditable(false);
        txtDetalles.setBackground(Color.DARK_GRAY);
        txtDetalles.setForeground(Color.WHITE);
        txtDetalles.setFont(new Font("Tahoma", Font.PLAIN, 14));
        panelDetalles.add(new JScrollPane(txtDetalles), BorderLayout.CENTER);
        add(panelDetalles, BorderLayout.EAST);

        // Cargar reuniones desde el servidor
        cargarReuniones();

        // Listener para doble clic en la tabla
        table.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                if (e.getClickCount() == 2 && table.getSelectedRow() != -1) {
                    detallesReunion(); // Doble clic para ver detalles
                }
            }
        });
    }

    private void cargarReuniones() {
        try (Socket socket = new Socket("10.5.104.41", 12345); // IP y puerto del servidor
             ObjectOutputStream out = new ObjectOutputStream(socket.getOutputStream());
             ObjectInputStream in = new ObjectInputStream(socket.getInputStream())) {

            // Simular envío del usuario logeado (ID del profesor)
            int profesorId = 5; // Aquí usa el ID de GlobalData si ya lo tienes
            out.writeObject("BILERA");
            out.writeObject(profesorId);
            out.flush();

            // Leer respuesta del servidor
            String respuesta = (String) in.readObject();
            if ("OK".equals(respuesta)) {
                List<Reuniones> reuniones = (List<Reuniones>) in.readObject();
                for (Reuniones reunion : reuniones) {
                    model.addRow(new Object[]{
                            reunion.getFecha().toLocalDateTime().toLocalDate().toString(),
                            reunion.getFecha().toLocalDateTime().toLocalTime().toString(),
                            reunion.getEstado(),
                            "Ver detalles"
                    });
                }
            } else {
                JOptionPane.showMessageDialog(this, "Error al obtener reuniones del servidor.", 
                                              "Error", JOptionPane.ERROR_MESSAGE);
            }
        } catch (Exception e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(this, "Error al conectar con el servidor.", 
                                          "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void detallesReunion() {
        int selectedRow = table.getSelectedRow();
        if (selectedRow != -1) {
            JOptionPane.showMessageDialog(this,
                    "Detalles de la reunión seleccionada:\n\n" +
                            "Fecha: " + table.getValueAt(selectedRow, 0) + "\n" +
                            "Hora: " + table.getValueAt(selectedRow, 1) + "\n" +
                            "Estado: " + table.getValueAt(selectedRow, 2),
                    "Detalles de la reunión",
                    JOptionPane.INFORMATION_MESSAGE);
        }
    }

    public static void main(String[] args) {
        BileraV bileraV = new BileraV();
        bileraV.setVisible(true);
    }
}

// Renderer personalizado para colores según el estado
class EstadoRenderer extends DefaultTableCellRenderer {
    @Override
    public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
        Component c = super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);

        String estado = (String) table.getValueAt(row, 2); // Estado en la columna 2
        switch (estado.toLowerCase()) {
            case "pendiente":
                c.setBackground(new Color(255, 165, 0)); // Naranja
                break;
            case "conflicto":
                c.setBackground(Color.GRAY); // Gris
                break;
            case "aceptada":
                c.setBackground(new Color(144, 238, 144)); // Verde claro
                break;
            case "denegada":
                c.setBackground(new Color(255, 69, 0)); // Rojo
                break;
            default:
                c.setBackground(Color.WHITE); // Blanco por defecto
                break;
        }

        c.setForeground(Color.BLACK); // Texto negro
        return c;
    }
}
